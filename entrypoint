#!/bin/bash

# hide ^C
stty -echoctl

if [ "$#" != "1" ]; then
    echo "You need to provide a single argument."
    exit 1
fi

HMMFILE="/app/data/$1"
if ! test -f "$HMMFILE"; then
    echo "$HMMFILE does not exist."
    exit 1
fi

echo -n "Pressing $HMMFILE... "
/app/bin/hmmpress "$HMMFILE" >/dev/null || exit 1
echo "done."

# turn on bash's job control
set -m

export HMMFILE
/usr/bin/supervisord -c /app/conf/supervisord.conf --pidfile /var/run/supervisor.pid -n &

sleep 2

/usr/bin/supervisorctl start h3master
/usr/bin/supervisorctl start h3worker

fg %1
